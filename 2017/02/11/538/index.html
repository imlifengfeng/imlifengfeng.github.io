<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>iOS NSURLSession详解 | imlifengfeng</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS NSURLSession详解</h1><a id="logo" href="/.">imlifengfeng</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS NSURLSession详解</h1><div class="post-meta">Feb 11, 2017<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><p>一、<strong>概述</strong></p>
<p>NSURLSession在2013年随着iOS7的发布一起面世，苹果对它的定位是作为NSURLConnection的替代者，然后逐步将NSURLConnection退出历史舞台。现在使用最广泛的第三方网络框架：AFNetworking、SDWebImage等等都使用了NSURLSession。</p>
<p>Session翻译为中文意思是会话，我们知道，在七层网络协议中有物理层-&gt;数据链路层-&gt;网络层-&gt;传输层-&gt;会话层-&gt;表示层-&gt;应用层，那我们可以将NSURLSession类理解为会话层，用于管理网络接口的创建、维护、删除等等工作，我们要做的工作也只是会话层之后的层即可，底层的工作NSURLSession已经帮我们封装好了。</p>
<p>在WWDC 2013中，Apple的团队对NSURLConnection进行了重构，并推出了NSURLSession作为替代。NSURLSession将NSURLConnection替换为<em>NSURLSession</em>和<em>NSURLSessionConfiguration</em>，以及3个NSURLSessionTask的子类：<em>NSURLSessionDataTask</em>, <em>NSURLSessionUploadTask</em>, 和<em>NSURLSessionDownloadTask</em>。</p>
<p>它们之间的关系如下图：</p>
<p><img src="/images/2017/02/Snip20170211_1.png" alt="Snip20170211_1"></p>
<p>NSURLSessionTask及三个子类继承关系：</p>
<p><img src="/images/2017/02/7f6418d2-de8b-3006-a57f-95b3bd6c96cf.png" alt="7f6418d2-de8b-3006-a57f-95b3bd6c96cf"></p>
<p><em>NSURLSessionDataTask</em>: 主要用于读取服务端的简单数据，比如 JSON 数据。</p>
<p><em>NSURLSessionDownloadTask</em>: 这个 task 的主要用途是进行文件下载，它针对大文件的网络请求做了更多的处理，比如下载进度，断点续传等等。</p>
<p><em>NSURLSessionUploadTask</em>: 和下载任务对应，这个 task 主要是用于对服务端发送文件类型的数据使用的。</p>
<p>二、<strong>NSURLSession的使用</strong></p>
<p>NSURLSession 本身是不会进行请求的，而是通过创建 task 的形式进行网络请求（resume() 方法的调用），同一个 NSURLSession 可以创建多个 task，并且这些 task 之间的 cache 和 cookie 是共享的。NSURLSession的使用有如下几步：</p>
<ul>
<li>第一步：创建NSURLSession对象</li>
</ul>
<ul>
<li>第二步：使用NSURLSession对象创建Task</li>
</ul>
<ul>
<li>第三步：启动任务</li>
</ul>
<p>1、创建NSURLSession对象</p>
<p>NSURLSession对象的创建有如下三种方法：</p>
<p>（1）直接创建</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br></pre></td></tr></table></figure>
<p>（2）配置后创建</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[NSURLSession sessionWithConfiguration:defaultSessionConfiguration]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>（3）设置加代理获得</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用代理方法需要设置代理,但是session的delegate属性是只读的,要想设置代理只能通过这种方式创建session</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]</span><br><span class="line">    delegate:<span class="keyword">self</span></span><br><span class="line">    delegateQueue:[[<span class="built_in">NSOperationQueue</span> alloc] init]];</span><br></pre></td></tr></table></figure>
<p>关于NSURLSession的配置有三种类型：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//默认的配置会将缓存存储在磁盘上</span></span><br><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)defaultSessionConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="comment">//瞬时会话模式不会创建持久性存储的缓存</span></span><br><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)ephemeralSessionConfiguration;</span><br><span class="line"></span><br><span class="line"><span class="comment">//后台会话模式允许程序在后台进行上传下载工作</span></span><br><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)backgroundSessionConfigurationWithIdentifier:(<span class="built_in">NSString</span> *)identifier</span><br></pre></td></tr></table></figure>
<p>2、使用NSURLSession对象创建Task</p>
<p>NSURLSessionTask的创建要根据具体需要创建相应类型的Task。</p>
<p>（1）NSURLSessionDataTask</p>
<p>通过request对象或url创建：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="name">NSURLSessionDataTask</span> *)dataTaskWithRequest:(NSURLRequest *)request<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">- (<span class="name">NSURLSessionDataTask</span> *)dataTaskWithURL:(NSURL *)url<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>通过request对象或url创建，同时指定任务完成后通过completionHandler指定回调的代码块：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;    </span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithURL:(<span class="built_in">NSURL</span> *)url completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;</span><br></pre></td></tr></table></figure>
<p>（2）NSURLSessionUploadTask</p>
<p>通过request创建，在上传时指定文件源或数据源：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(NSURLSessionUploadTask *)</span>uploadTaskWithRequest:<span class="params">(NSURLRequest *)</span>request fromFile:<span class="params">(NSURL *)</span>fileURL;  </span><br><span class="line">   </span><br><span class="line">- <span class="params">(NSURLSessionUploadTask *)</span>uploadTaskWithRequest:<span class="params">(NSURLRequest *)</span>request fromData:<span class="params">(NSData *)</span>bodyData;  </span><br><span class="line">  </span><br><span class="line">- <span class="params">(NSURLSessionUploadTask *)</span>uploadTaskWithStreamedRequest:<span class="params">(NSURLRequest *)</span>request;</span><br></pre></td></tr></table></figure>
<p>通过completionHandler指定任务完成后的回调代码块：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromFile:(<span class="built_in">NSURL</span> *)fileURL completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;    </span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromData:(<span class="built_in">NSData</span> *)bodyData completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;</span><br></pre></td></tr></table></figure>
<p>（3）NSURLSessionDownloadTask</p>
<p>下载任务支持断点续传，第三种方式是通过之前已经下载的数据来创建下载任务：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="name">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(NSURLRequest *)request<span class="comment">;    </span></span><br><span class="line">    </span><br><span class="line">- (<span class="name">NSURLSessionDownloadTask</span> *)downloadTaskWithURL:(NSURL *)url<span class="comment">;    </span></span><br><span class="line">  </span><br><span class="line">- (<span class="name">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(NSData *)resumeData<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>同样地可以通过completionHandler指定任务完成后的回调代码块：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;    </span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithURL:(<span class="built_in">NSURL</span> *)url completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;    </span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(<span class="built_in">NSData</span> *)resumeData completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;</span><br></pre></td></tr></table></figure>
<p>我们在使用三种 task 的任意一种的时候都可以指定相应的代理。NSURLSession 的代理对象结构如下：</p>
<p><img src="/images/2017/02/a01337ad-ac97-3b9a-8ee7-f5b261747202.png" alt="a01337ad-ac97-3b9a-8ee7-f5b261747202"></p>
<p><em>NSURLSessionDelegate</em> - 作为所有代理的基类，定义了网络请求最基础的代理方法。</p>
<p><em>NSURLSessionTaskDelegate</em> - 定义了网络请求任务相关的代理方法。</p>
<p><em>NSURLSessionDownloadDelegate</em> - 用于下载任务相关的代理方法，比如下载进度等等。</p>
<p><em>NSURLSessionDataDelegate</em> - 用于普通数据任务和上传任务。</p>
<p>相信大家都会使用代理，具体的使用方法这里不再讲解。</p>
<p>3、启动任务</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动任务</span></span><br><span class="line">[<span class="meta">task resume</span>];</span><br></pre></td></tr></table></figure>
<p>三、<strong>GET请求与POST请求</strong></p>
<p>我们可以使用NSURLSessionDataTask进行GET请求与POST请求。</p>
<p>1、GET 请求</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、创建NSURLSession对象</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"></span><br><span class="line"><span class="comment">//2、利用NSURLSession创建任务(task)</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.xxx.com/login?username=myName&amp;pwd=myPsd"</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithURL:url completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[[<span class="built_in">NSString</span> alloc]initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</span><br><span class="line">    <span class="comment">//打印解析后的json数据</span></span><br><span class="line">    <span class="comment">//NSLog(@"%@", [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:nil]);</span></span><br><span class="line"></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//3、执行任务</span></span><br><span class="line">[task resume];</span><br></pre></td></tr></table></figure>
<p>2、POST请求</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、创建NSURLSession对象</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"></span><br><span class="line"><span class="comment">//2、利用NSURLSession创建任务(task)</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.xxx.com/login"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建请求对象里面包含请求体</span></span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">request.HTTPMethod = <span class="string">@"POST"</span>;</span><br><span class="line">request.HTTPBody = [<span class="string">@"username=myName&amp;pwd=myPsd"</span> dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">      </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,[[<span class="built_in">NSString</span> alloc]initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</span><br><span class="line">    <span class="comment">//打印解析后的json数据</span></span><br><span class="line">    <span class="comment">//NSLog(@"%@", [NSJSONSerialization JSONObjectWithData:data options:kNilOptions error:nil]);</span></span><br><span class="line"></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//3、执行任务</span></span><br><span class="line"> [task resume];</span><br></pre></td></tr></table></figure>
<p>四、<strong>文件的上传</strong></p>
<p>我们可以使用NSURLSessionUploadTask进行文件的上传，使用NSURLSessionUploadTask文件上传共有两种方法：</p>
<p>方法1：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionUploadTask</span> *task =</span><br><span class="line">[[<span class="built_in">NSURLSession</span> sharedSession] uploadTaskWithRequest:request</span><br><span class="line">                                           fromFile:fileName</span><br><span class="line">                                  completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">self.session</span> uploadTaskWithRequest:request</span><br><span class="line">                            fromData:body</span><br><span class="line">                   completionHandler:^(<span class="name">NSData</span> *data, NSURLResponse *response, NSError *error) &#123;</span><br><span class="line"> NSLog(<span class="name">@</span><span class="string">"-------%@"</span>, [<span class="name">NSJSONSerialization</span> JSONObjectWithData:data options:kNilOptions error:nil])<span class="comment">;</span></span><br><span class="line"> &#125;]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>1、以数据流的方式进行上传</p>
<p>这种方式好处就是大小不受限制，示例代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>) <span class="built_in">NSURLSessionBinaryUploadTaskTest</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建url</span></span><br><span class="line">    <span class="built_in">NSString</span> *urlString = <span class="string">@"http://www.xxxx.com/upload.php"</span>;</span><br><span class="line">    <span class="comment">// urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[NSCharacterSet URLFragmentAllowedCharacterSet]];</span></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:urlString];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建请求</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">    <span class="comment">// 文件上传使用post</span></span><br><span class="line">    request.HTTPMethod = <span class="string">@"POST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.开始上传   request的body data将被忽略，而由fromData提供</span></span><br><span class="line">    [[[<span class="built_in">NSURLSession</span> sharedSession] uploadTaskWithRequest:request fromData:[<span class="built_in">NSData</span> dataWithContentsOfFile:<span class="string">@"/Users/lifengfeng/Desktop/test.jpg"</span>]     completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload success：%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload error:%@"</span>,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2、以拼接表单的方式进行上传</p>
<ul>
<li>上传的关键是请求体部分的表单拼接，获取本地上传文件的类型（MIME Types），至于具体的网络上传则很简单。 另外拼接表单的方式会有大小限制，即HTML的<code>MAX_FILE_SIZE</code>限制(可以自己设定，一般2MB)。</li>
</ul>
<ul>
<li>根据上面的继承关系图，我们知道uploadTask是dataTask的子类，也可以使用uploadTask来代替dataTask。</li>
</ul>
<p>表单拼接格式如下，boundary作为分界线：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--boundary</span><br><span class="line">Content-Disposition:<span class="keyword">form</span>-<span class="keyword">data</span>;<span class="keyword">name</span>=”表单控件名称”;filename=”上传文件名称”</span><br><span class="line">Content-<span class="keyword">Type</span>:要上传文件MIME Types</span><br><span class="line"></span><br><span class="line">要上传文件二进制数据;</span><br><span class="line"></span><br><span class="line">--boundary--</span><br></pre></td></tr></table></figure>
<p>示例代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="built_in">NSURLSessionUploadTaskTest</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建url  采用Apache本地服务器</span></span><br><span class="line">    <span class="built_in">NSString</span> *urlString = <span class="string">@"http://localhost/upload/upload.php"</span>;</span><br><span class="line">    urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[<span class="built_in">NSCharacterSet</span> URLFragmentAllowedCharacterSet]];</span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:urlString];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建请求</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">    <span class="comment">// 文件上传使用post</span></span><br><span class="line">    request.HTTPMethod = <span class="string">@"POST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *contentType = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"multipart/form-data; boundary=%@"</span>,<span class="string">@"boundary"</span>];</span><br><span class="line"></span><br><span class="line">    [request setValue:contentType forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    <span class="comment">// test.jpg</span></span><br><span class="line">    <span class="comment">// 3.拼接表单，大小受MAX_FILE_SIZE限制(2MB)  FilePath:要上传的本地文件路径  formName:表单控件名称，应于服务器一致</span></span><br><span class="line">    <span class="built_in">NSData</span>* data = [<span class="keyword">self</span> getHttpBodyWithFilePath:<span class="string">@"/Users/lifengfeng/Desktop/test.jpg"</span> formName:<span class="string">@"file"</span> reName:<span class="string">@"newName.png"</span>];</span><br><span class="line">    request.HTTPBody = data;</span><br><span class="line">    <span class="comment">// 根据需要是否提供，非必须,如果不提供，session会自动计算</span></span><br><span class="line">    [request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%lu"</span>,data.length] forHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.1 使用dataTask</span></span><br><span class="line">    [[[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload success：%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload error:%@"</span>,error);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;] resume];</span><br><span class="line"><span class="meta">#if 0</span></span><br><span class="line">    <span class="comment">// 4.2 开始上传 使用uploadTask   fromData:可有可无，会被忽略</span></span><br><span class="line">    [[[<span class="built_in">NSURLSession</span> sharedSession] uploadTaskWithRequest:request fromData:<span class="literal">nil</span>     completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload success：%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:data encoding:<span class="built_in">NSUTF8StringEncoding</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"upload error:%@"</span>,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] resume];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中用到的两个自定义的方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// filePath:要上传的文件路径   formName：表单控件名称  reName：上传后文件名</span></span><br><span class="line">- (<span class="built_in">NSData</span> *)getHttpBodyWithFilePath:(<span class="built_in">NSString</span> *)filePath formName:(<span class="built_in">NSString</span> *)formName reName:(<span class="built_in">NSString</span> *)reName</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableData</span> *data = [<span class="built_in">NSMutableData</span> data];</span><br><span class="line">    <span class="built_in">NSURLResponse</span> *response = [<span class="keyword">self</span> getLocalFileResponse:filePath];</span><br><span class="line">    <span class="comment">// 文件类型：MIMEType  文件的大小：expectedContentLength  文件名字：suggestedFilename</span></span><br><span class="line">    <span class="built_in">NSString</span> *fileType = response.MIMEType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果没有传入上传后文件名称,采用本地文件名!</span></span><br><span class="line">    <span class="keyword">if</span> (reName == <span class="literal">nil</span>) &#123;</span><br><span class="line">        reName = response.suggestedFilename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表单拼接</span></span><br><span class="line">    <span class="built_in">NSMutableString</span> *headerStrM =[<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    [headerStrM appendFormat:<span class="string">@"--%@\r\n"</span>,<span class="string">@"boundary"</span>];</span><br><span class="line">    <span class="comment">// name：表单控件名称  filename：上传文件名</span></span><br><span class="line">    [headerStrM appendFormat:<span class="string">@"Content-Disposition: form-data; name=%@; filename=%@\r\n"</span>,formName,reName];</span><br><span class="line">    [headerStrM appendFormat:<span class="string">@"Content-Type: %@\r\n\r\n"</span>,fileType];</span><br><span class="line">    [data appendData:[headerStrM dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>]];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件内容</span></span><br><span class="line">    <span class="built_in">NSData</span> *fileData = [<span class="built_in">NSData</span> dataWithContentsOfFile:filePath];</span><br><span class="line">    [data appendData:fileData];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableString</span> *footerStrM = [<span class="built_in">NSMutableString</span> stringWithFormat:<span class="string">@"\r\n--%@--\r\n"</span>,<span class="string">@"boundary"</span>];</span><br><span class="line">    [data appendData:[footerStrM  dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>]];</span><br><span class="line"><span class="comment">//    NSLog(@"dataStr=%@",[[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]);</span></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 获取响应，主要是文件类型和文件名</span></span><br><span class="line">- (<span class="built_in">NSURLResponse</span> *)getLocalFileResponse:(<span class="built_in">NSString</span> *)urlString</span><br><span class="line">&#123;</span><br><span class="line">    urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[<span class="built_in">NSCharacterSet</span> URLFragmentAllowedCharacterSet]];</span><br><span class="line">    <span class="comment">// 本地文件请求</span></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> fileURLWithPath:urlString];</span><br><span class="line">    <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:url];</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSURLResponse</span> *localResponse = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">// 使用信号量实现NSURLSession同步请求</span></span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    [[[<span class="built_in">NSURLSession</span> sharedSession] dataTaskWithRequest:request completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        localResponse = response;</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;] resume];</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="keyword">return</span>  localResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>五、<strong>文件的下载</strong></p>
<p>我们可以使用NSURLSessionDownloadTask实现文件的下载。NSURLSession使用代理方法也可以实现大文件下载，但是它实现不了断点下载，所以一般不用。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)<span class="built_in">NSURLSessionDownloadTaskTest</span> &#123;</span><br><span class="line">    <span class="comment">// 1.创建url</span></span><br><span class="line">    <span class="built_in">NSString</span> *urlString = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"http://www.xxx.com/test.mp3"</span>];</span><br><span class="line">    <span class="comment">// 一些特殊字符编码</span></span><br><span class="line">    urlString = [urlString stringByAddingPercentEncodingWithAllowedCharacters:[<span class="built_in">NSCharacterSet</span> URLQueryAllowedCharacterSet]];</span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:urlString];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.创建请求</span></span><br><span class="line">    <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:url];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.创建会话，采用苹果提供全局的共享session</span></span><br><span class="line">    <span class="built_in">NSURLSession</span> *sharedSession = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.创建任务</span></span><br><span class="line">    <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = [sharedSession downloadTaskWithRequest:request completionHandler:^(<span class="built_in">NSURL</span> * _Nullable location, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (error == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="comment">// location:下载任务完成之后,文件存储的位置，这个路径默认是在tmp文件夹下!</span></span><br><span class="line">            <span class="comment">// 只会临时保存，因此需要将其另存</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"location:%@"</span>,location.path);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 采用模拟器测试，为了方便将其下载到Mac桌面</span></span><br><span class="line"><span class="comment">//            NSString *filePath = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject];</span></span><br><span class="line">            <span class="built_in">NSString</span> *filePath = <span class="string">@"/Users/lifengfeng/Desktop/test.mp3"</span>;</span><br><span class="line">            <span class="built_in">NSError</span> *fileError;</span><br><span class="line">            [[<span class="built_in">NSFileManager</span> defaultManager] copyItemAtPath:location.path toPath:filePath error:&amp;fileError];</span><br><span class="line">            <span class="keyword">if</span> (fileError == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"file save success"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"file save error: %@"</span>,fileError);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"download error:%@"</span>,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.开启任务</span></span><br><span class="line">    [downloadTask resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上就是关于NSURLSession的用法，其中相关的代理方法并没有讲解，通过代理方法我们可以实现下载进度的获取等，具体的根据需要自己去实现。</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>imlifengfeng</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2017/02/11/538/">http://www.imlifengfeng.com/2017/02/11/538/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>原创文章，转载请注明来源</li></ul></div><br><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/NSURLSession/">NSURLSession</a></div><div class="post-nav"><a class="pre" href="/2017/02/11/543/">iOS CALayer详解</a><a class="next" href="/2017/02/09/533/">iOS多线程详解</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'c364198c7db8ed6a1011',
  clientSecret: '7613c9d1c4706bdebff2c7adf84efdf98839ec7d',
  repo: 'imlifengfeng.github.io',
  owner: 'imlifengfeng',
  admin: ['imlifengfeng'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.imlifengfeng.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/03/714/">iOS 的组件化开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/06/692/">iOS逆向工程之fishhook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/25/677/">iOS逆向工程之插件开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/03/674/">Swift算法实现之归并排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/672/">Swift算法实现之快速排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/31/669/">Swift算法实现之翻转二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/31/661/">Swift算法实现之二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/28/658/">Swift算法实现之栈和队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/27/654/">Swift算法实现之查找第K大的元素</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/23/652/">Swift算法实现之数组中出现次数超过一半的数字</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">imlifengfeng.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>