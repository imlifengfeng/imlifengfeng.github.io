<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>iOS KVC详解 | imlifengfeng</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS KVC详解</h1><a id="logo" href="/.">imlifengfeng</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS KVC详解</h1><div class="post-meta">Jan 16, 2017<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><p>一、<strong>概述</strong></p>
<p>KVC（Key-value coding）键值编码，iOS的开发中，可以允许开发者通过Key名直接访问对象的属性，或者给对象的属性赋值。而不需要调用明确的存取方法。这样就可以在运行时动态在访问和修改对象的属性，而不是在编译时确定。</p>
<p>在实现了访问器方法的类中，使用点语法和KVC访问对象其实差别不大，二者可以任意混用。但是没有访问起方法的类中，点语法无法使用，这时KVC就有优势了。</p>
<p>二、<strong>KVC的定义与使用</strong></p>
<p>1、KVC相关的方法</p>
<p>KVC的定义都是对NSObject的扩展来实现的，Objective-c中有个显式的NSKeyValueCoding类别名，所以对于所有继承了NSObject在类型，都能使用KVC，下面是KVC最为重要的四个方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;                          <span class="comment">//直接通过Key来取值</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;          <span class="comment">//通过Key来设值</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;                  <span class="comment">//通过KeyPath来取值</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;  <span class="comment">//通过KeyPath来设值</span></span><br></pre></td></tr></table></figure>
<p>当然NSKeyValueCoding类别中还有其他的一些方法，例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)accessInstanceVariablesDirectly;</span><br><span class="line"><span class="comment">//默认返回YES，表示如果没有找到Set&lt;Key&gt;方法的话，会按照_key，_iskey，key，iskey的顺序搜索成员，设置成NO就不这样搜索</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> __<span class="keyword">nullable</span> * __<span class="keyword">nonnull</span>)ioValue forKey:(<span class="built_in">NSString</span> *)inKey error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line"><span class="comment">//KVC提供属性值确认的API，它可以用来检查set的值是否正确、为不正确的值做一个替换值或者拒绝设置新值并返回错误原因。</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">//这是集合操作的API，里面还有一系列这样的API，如果属性是一个NSMutableArray，那么可以用这个方法来返回</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">//如果Key不存在，且没有KVC无法搜索到任何和Key有关的字段或者属性，则会调用这个方法，默认是抛出异常</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">//和上一个方法一样，只不过是设值。</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"><span class="comment">//如果你在SetValue方法时面给Value传nil，则会调用这个方法</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br><span class="line"><span class="comment">//输入一组key,返回该组key对应的Value，再转成字典返回，用于将Model转到字典。</span></span><br></pre></td></tr></table></figure>
<p>同时苹果对一些容器类比如NSArray或者NSSet等，KVC有着特殊的实现。</p>
<p>有序集合对应方法如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">-countOf<span class="symbol">&lt;Key&gt;</span>//必须实现，对应于NSArray的基本方法coun<span class="variable">t:2</span>  -objectIn<span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="symbol">&lt;key&gt;</span>AtIndexe<span class="variable">s:</span>//这两个必须实现一个，对应于 NSArray 的方法 objectAtIndex: 和 objectsAtIndexe<span class="variable">s:</span></span><br><span class="line"></span><br><span class="line">-<span class="built_in">get</span><span class="symbol">&lt;Key&gt;</span>:<span class="built_in">range</span>://不是必须实现的，但实现后可以提高性能，其对应于 NSArray 方法 getObject<span class="variable">s:range</span>:</span><br><span class="line"></span><br><span class="line">-insertObjec<span class="variable">t:in</span><span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="keyword">insert</span><span class="symbol">&lt;Key&gt;</span>:atIndexe<span class="variable">s:</span>//两个必须实现一个，类似于 NSMutableArray 的方法 insertObjec<span class="variable">t:atIndex</span>: 和 insertObject<span class="variable">s:atIndexes</span>:</span><br><span class="line"></span><br><span class="line">-removeObjectFrom<span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="built_in">remove</span><span class="symbol">&lt;Key&gt;</span>AtIndexe<span class="variable">s:</span>//两个必须实现一个，类似于 NSMutableArray 的方法 removeObjectAtIndex: 和 removeObjectsAtIndexe<span class="variable">s:</span></span><br><span class="line"></span><br><span class="line">-replaceObjectIn<span class="symbol">&lt;Key&gt;</span>AtIndex:withObjec<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">-replace<span class="symbol">&lt;Key&gt;</span>AtIndexe<span class="variable">s:with</span><span class="symbol">&lt;Key&gt;</span>://可选的，如果在此类操作上有性能问题，就需要考虑实现之</span><br></pre></td></tr></table></figure>
<p>无序集合对应方法如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-countOf<span class="symbol">&lt;Key&gt;</span>//必须实现，对应于NSArray的基本方法coun<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">-objectIn<span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="symbol">&lt;key&gt;</span>AtIndexe<span class="variable">s:</span>//这两个必须实现一个，对应于 NSArray 的方法 objectAtIndex: 和 objectsAtIndexe<span class="variable">s:</span></span><br><span class="line"></span><br><span class="line">-<span class="built_in">get</span><span class="symbol">&lt;Key&gt;</span>:<span class="built_in">range</span>://不是必须实现的，但实现后可以提高性能，其对应于 NSArray 方法 getObject<span class="variable">s:range</span>:</span><br><span class="line"></span><br><span class="line">-insertObjec<span class="variable">t:in</span><span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="keyword">insert</span><span class="symbol">&lt;Key&gt;</span>:atIndexe<span class="variable">s:</span>//两个必须实现一个，类似于 NSMutableArray 的方法 insertObjec<span class="variable">t:atIndex</span>: 和 insertObject<span class="variable">s:atIndexes</span>:</span><br><span class="line"></span><br><span class="line">-removeObjectFrom<span class="symbol">&lt;Key&gt;</span>AtIndex:</span><br><span class="line"></span><br><span class="line">-<span class="built_in">remove</span><span class="symbol">&lt;Key&gt;</span>AtIndexe<span class="variable">s:</span>//两个必须实现一个，类似于 NSMutableArray 的方法 removeObjectAtIndex: 和 removeObjectsAtIndexe<span class="variable">s:</span></span><br><span class="line"></span><br><span class="line">-replaceObjectIn<span class="symbol">&lt;Key&gt;</span>AtIndex:withObjec<span class="variable">t:</span></span><br><span class="line"></span><br><span class="line">-replace<span class="symbol">&lt;Key&gt;</span>AtIndexe<span class="variable">s:with</span><span class="symbol">&lt;Key&gt;</span>://这两个都是可选的，如果在此类操作上有性能问题，就需要考虑实现之</span><br></pre></td></tr></table></figure>
<p>2、一对多关系（To-Many）中的集合访问器方法</p>
<p>我们平时大部分使用的属性都是一对一关系（To-One）,比如Person类中的name属性，每个人只有一个名字。但也有一对多的关系，比如Person中有一个friendsName属性，这是个集合（在Objective-C中可以是NSArray，NSSet等），保存的是一个人的所有朋友的名字。</p>
<p>当操作一对多的属性中的内容时，我们有两种选择：</p>
<p>（1）间接操作<br>先通过KVC方法取到集合属性，然后通过集合属性操作集合中的元素。实际开发中最常用的方法。</p>
<p>（2）直接操作<br>苹果为我们提供了一些方法模板（即上面提到的有序集合和无序集合对应的方法），我们可以以规定的格式实现这些方法来达到访问集合属性中元素的目的。不过在实际开发中一般不使用直接操作的方法，使用间接操作就足够了，苹果甚至都没有让这些方法以哪怕是非正式协议的形式出现，而只是在编程指南中提了一下。</p>
<p>3、KVC对数值和结构体型属性的支持</p>
<p>KVC可以自动的将数值或结构体型的数据打包或解包成NSNumber或NSValue对象，以达到适配的目的。</p>
<p>举个例子，Person类有个NSInteger类型的age属性，如下:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  Person.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Person.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>（1）修改值</p>
<p>我们通过KVC技术使用如下方式设置age属性的值：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">person</span> setValue:[<span class="name">NSNumber</span> numberWithInteger:5] forKey:@<span class="string">"age"</span>]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>我们赋给age的是一个<code>NSNumber</code>对象，KVC会自动的将<code>NSNumber</code>对象转换成<code>NSInteger</code>对象，然后再调用相应的访问器方法设置age的值。</p>
<p>（2）获取值</p>
<p>同样，以如下方式获取age属性值：</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">person</span> valueForKey:@<span class="string">"age"</span>]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这时，会以NSNumber的形式返回age的值。</p>
<p>例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  ViewController.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"Person.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    Person *person = [[Person alloc]init];</span><br><span class="line">    [person setValue:[<span class="built_in">NSNumber</span> numberWithInteger:<span class="number">5</span>] forKey:<span class="string">@"age"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"age=%@"</span>,[person valueForKey:<span class="string">@"age"</span>]);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017-01-16</span> <span class="number">16</span>:<span class="number">31:55.709</span> Test[<span class="number">28586:2294177</span>] age=<span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>需要注意的是我们不能直接将一个数值通过KVC赋值的，我们需要把数据转为NSNumber和NSValue类型传入，那到底哪些类型数据要用NSNumber封装哪些类型数据要用NSValue封装呢？看下面这些方法的参数类型就知道了：</p>
<p>可以使用NSNumber的数据类型有：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithChar:(<span class="keyword">char</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedChar:(unsignedchar)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithShort:(<span class="keyword">short</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedShort:(unsignedshort)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithInt:(<span class="keyword">int</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedInt:(unsignedint)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithLong:(<span class="keyword">long</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedLong:(unsignedlong)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithLongLong:(longlong)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedLongLong:(unsignedlonglong)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithFloat:(<span class="keyword">float</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithDouble:(<span class="keyword">double</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithBool:(<span class="built_in">BOOL</span>)value;</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithInteger:(<span class="built_in">NSInteger</span>)valueNS_AVAILABLE(<span class="number">10</span>_5,<span class="number">2</span>_0);</span><br><span class="line">+ (<span class="built_in">NSNumber</span>*)numberWithUnsignedInteger:(<span class="built_in">NSUInteger</span>)valueNS_AVAILABLE(<span class="number">10</span>_5,<span class="number">2</span>_0);</span><br></pre></td></tr></table></figure>
<p>就是一些常见的数值型数据。</p>
<p>可以使用NSValue的数据类型有：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithCGPoint:(<span class="built_in">CGPoint</span>)point;</span><br><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithCGSize:(<span class="built_in">CGSize</span>)size;</span><br><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithCGRect:(<span class="built_in">CGRect</span>)rect;</span><br><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithCGAffineTransform:(<span class="built_in">CGAffineTransform</span>)transform;</span><br><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithUIEdgeInsets:(<span class="built_in">UIEdgeInsets</span>)insets;</span><br><span class="line">+ (<span class="built_in">NSValue</span>*)valueWithUIOffset:(<span class="built_in">UIOffset</span>)insetsNS_AVAILABLE_IOS(<span class="number">5</span>_0);</span><br></pre></td></tr></table></figure>
<p><code>NSValue</code>主要用于处理结构体型的数据，它本身提供了如上集中结构的支持。任何结构体都是可以转化成NSValue对象的，包括其它自定义的结构体。</p>
<p>三、<strong>KVC中使用KeyPath</strong></p>
<p>在开发过程中，一个类的成员变量有可能是其他的自定义类，你可以先用KVC获取出来该属性，然后再次用KVC来获取这个自定义类的属性，但这样是比较繁琐的，对此，KVC提供了一个解决方案，那就是键路径KeyPath。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;                  <span class="comment">//通过KeyPath来取值</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;  <span class="comment">//通过KeyPath来设值</span></span><br></pre></td></tr></table></figure>
<p>KVC 同样允许我们通过关系来访问对象。假设 <code>people</code> 对象有属性 <code>address</code>，<code>address</code> 有属性 <code>country</code>，我们可以这样通过people 来访问country：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">people valueForKeyPath:@<span class="meta-string">"address.country"</span></span>]；</span><br></pre></td></tr></table></figure>
<p>值得注意的是这里我们调用 <code>-valueForKeyPath:</code> 而不是 <code>-valueForKey:</code>。</p>
<p>例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  main.m</span></span><br><span class="line"><span class="comment">//  TEST_OC</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by 李峰峰 on 2017/1/16.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 李峰峰. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Address</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Address</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span>* country;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Address</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">People</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">People</span>()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>) <span class="built_in">NSString</span>* name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>) Address* address;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">People</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        People* people1 = [People new];</span><br><span class="line">        Address* add = [Address new];</span><br><span class="line">        add.country = <span class="string">@"China"</span>;</span><br><span class="line">        people1.address = add;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSString</span>* country1 = people1.address.country;</span><br><span class="line">        <span class="built_in">NSString</span> * country2 = [people1 valueForKeyPath:<span class="string">@"address.country"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"country1:%@   country2:%@"</span>,country1,country2);</span><br><span class="line">        </span><br><span class="line">        [people1 setValue:<span class="string">@"USA"</span> forKeyPath:<span class="string">@"address.country"</span>];</span><br><span class="line">        country1 = people1.address.country;</span><br><span class="line">        country2 = [people1 valueForKeyPath:<span class="string">@"address.country"</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"country1:%@   country2:%@"</span>,country1,country2);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">42.443432</span> TEST_OC[<span class="number">29905</span>:<span class="number">2372748</span>] country1:China   country2:China</span><br><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">42.444862</span> TEST_OC[<span class="number">29905</span>:<span class="number">2372748</span>] country1:USA   country2:USA</span><br><span class="line">Program ended with <span class="keyword">exit</span> code: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>KVC键值验证（Key-Value Validation）</p>
<p>KVC提供了验证Key对应的Value是否可用的方法：</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="params">(BOOL)</span>validateValue:<span class="params">(inoutid*)</span>ioValue forKey:<span class="params">(NSString*)</span>inKey error:<span class="params">(outNSError**)</span>outError;</span><br></pre></td></tr></table></figure>
<p>该方法默认的实现是调用一个如下格式的方法：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">BOOL</span>)validate&lt;<span class="built_in">Key</span>&gt;:<span class="built_in">error</span>:</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Address</span></span></span><br><span class="line">-(<span class="built_in">BOOL</span>)validateCountry:(<span class="keyword">id</span> *)value error:(<span class="keyword">out</span> <span class="built_in">NSError</span> * _Nullable __autoreleasing *)outError&#123;  <span class="comment">//在implementation里面加这个方法，它会验证是否设了非法的value</span></span><br><span class="line">    <span class="built_in">NSString</span>* country = *value;</span><br><span class="line">    country = country.capitalizedString;</span><br><span class="line">    <span class="keyword">if</span> ([country isEqualToString:<span class="string">@"Japan"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;                                                                             <span class="comment">//如果国家是日本，就返回NO，这里省略了错误提示，</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSError</span>* error;</span><br><span class="line"><span class="keyword">id</span> value = <span class="string">@"japan"</span>;</span><br><span class="line"><span class="built_in">NSString</span>* key = <span class="string">@"country"</span>;</span><br><span class="line"><span class="built_in">BOOL</span> result = [add validateValue:&amp;value forKey:key error:&amp;error]; <span class="comment">//如果没有重写-(BOOL)-validate&lt;Key&gt;:error:，默认返回Yes</span></span><br><span class="line"><span class="keyword">if</span> (result) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"键值匹配"</span>);</span><br><span class="line">    [add setValue:value forKey:key];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"键值不匹配"</span>); <span class="comment">//不能设为日本，基他国家都行</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">NSString</span>* country = [add valueForKey:<span class="string">@"country"</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"country:%@"</span>,country);</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017<span class="selector-tag">-01-16</span> 17<span class="selector-pseudo">:27</span><span class="selector-pseudo">:46.424332</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[29905:2372748]</span> 键值不匹配</span><br><span class="line">2017<span class="selector-tag">-01-16</span> 17<span class="selector-pseudo">:27</span><span class="selector-pseudo">:46.424332</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[29905:2372748]</span> <span class="selector-tag">country</span><span class="selector-pseudo">:China</span></span><br></pre></td></tr></table></figure>
<p>这样就给了我们一次纠错的机会。需要指出的是，KVC是不会自动调用键值验证方法的，就是说我们如果想要键值验证则需要手动验证。但是有些技术，比如CoreData会自动调用。</p>
<p>上面的代码简单在展示了KeyPath是怎么用的。如果你不小心错误的使用了key而非KeyPath的话，KVC会直接查找address.country这个属性，很明显，这个属性并不存在，所以会再调用UndefinedKey相关方法。而KVC对于KeyPath是搜索机制第一步就是分离key，用小数点.来分割key，然后再像普通key一样按照先前介绍的顺序搜索下去。接下来就来研究KVC是怎么寻找Key的。</p>
<p>四、<strong>用KVC中的函数操作集合</strong></p>
<p>KVC同时还提供了很复杂的函数，主要有下面这些：<br>1、简单集合运算符<br>简单集合运算符共有<code>@avg， @count ， @max ， @min ，@sum5</code>种，都表示什么直接看下面例子就明白了， 目前还不支持自定义。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  main.m</span></span><br><span class="line"><span class="comment">//  TEST_OC</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by 李峰峰 on 2017/1/16.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 李峰峰. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)  <span class="built_in">NSString</span>* name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)  <span class="built_in">CGFloat</span> price;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Book</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Book *book1 = [Book new];</span><br><span class="line">        book1.name = <span class="string">@"The Great Gastby"</span>;</span><br><span class="line">        book1.price = <span class="number">10</span>;</span><br><span class="line">        Book *book2 = [Book new];</span><br><span class="line">        book2.name = <span class="string">@"Time History"</span>;</span><br><span class="line">        book2.price = <span class="number">20</span>;</span><br><span class="line">        Book *book3 = [Book new];</span><br><span class="line">        book3.name = <span class="string">@"Wrong Hole"</span>;</span><br><span class="line">        book3.price = <span class="number">30</span>;</span><br><span class="line">        </span><br><span class="line">        Book *book4 = [Book new];</span><br><span class="line">        book4.name = <span class="string">@"Wrong Hole"</span>;</span><br><span class="line">        book4.price = <span class="number">40</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSArray</span>* arrBooks = @[book1,book2,book3,book4];</span><br><span class="line">        <span class="built_in">NSNumber</span>* sum = [arrBooks valueForKeyPath:<span class="string">@"@sum.price"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"sum:%f"</span>,sum.floatValue);</span><br><span class="line">        <span class="built_in">NSNumber</span>* avg = [arrBooks valueForKeyPath:<span class="string">@"@avg.price"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"avg:%f"</span>,avg.floatValue);</span><br><span class="line">        <span class="built_in">NSNumber</span>* count = [arrBooks valueForKeyPath:<span class="string">@"@count"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"count:%f"</span>,count.floatValue);</span><br><span class="line">        <span class="built_in">NSNumber</span>* min = [arrBooks valueForKeyPath:<span class="string">@"@min.price"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"min:%f"</span>,min.floatValue);</span><br><span class="line">        <span class="built_in">NSNumber</span>* max = [arrBooks valueForKeyPath:<span class="string">@"@max.price"</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"max:%f"</span>,max.floatValue);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:53</span><span class="selector-pseudo">:23.235907</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37115:3010741]</span> <span class="selector-tag">sum</span><span class="selector-pseudo">:100.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:53</span><span class="selector-pseudo">:23.236161</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37115:3010741]</span> <span class="selector-tag">avg</span><span class="selector-pseudo">:25.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:53</span><span class="selector-pseudo">:23.236227</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37115:3010741]</span> <span class="selector-tag">count</span><span class="selector-pseudo">:4.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:53</span><span class="selector-pseudo">:23.236280</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37115:3010741]</span> <span class="selector-tag">min</span><span class="selector-pseudo">:10.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:53</span><span class="selector-pseudo">:23.236322</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37115:3010741]</span> <span class="selector-tag">max</span><span class="selector-pseudo">:40.000000</span></span><br><span class="line"><span class="selector-tag">Program</span> <span class="selector-tag">ended</span> <span class="selector-tag">with</span> <span class="selector-tag">exit</span> <span class="selector-tag">code</span>: 0</span><br></pre></td></tr></table></figure>
<p>2、对象运算符<br>比集合运算符稍微复杂，能以数组的方式返回指定的内容，一共有两种：<br><code>@distinctUnionOfObjects</code><br><code>@unionOfObjects</code><br>它们的返回值都是NSArray，区别是前者返回的元素都是唯一的，是去重以后的结果；后者返回的元素是全集。</p>
<p>例如：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  main.m</span></span><br><span class="line"><span class="comment">//  TEST_OC</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by 李峰峰 on 2017/1/16.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 李峰峰. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Book</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)  <span class="built_in">NSString</span>* name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">assign</span>)  <span class="built_in">CGFloat</span> price;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Book</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        Book *book1 = [Book new];</span><br><span class="line">        book1.name = <span class="string">@"The Great Gastby"</span>;</span><br><span class="line">        book1.price = <span class="number">40</span>;</span><br><span class="line">        Book *book2 = [Book new];</span><br><span class="line">        book2.name = <span class="string">@"Time History"</span>;</span><br><span class="line">        book2.price = <span class="number">20</span>;</span><br><span class="line">        Book *book3 = [Book new];</span><br><span class="line">        book3.name = <span class="string">@"Wrong Hole"</span>;</span><br><span class="line">        book3.price = <span class="number">30</span>;</span><br><span class="line">        </span><br><span class="line">        Book *book4 = [Book new];</span><br><span class="line">        book4.name = <span class="string">@"Wrong Hole"</span>;</span><br><span class="line">        book4.price = <span class="number">10</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSArray</span>* arrBooks = @[book1,book2,book3,book4];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"distinctUnionOfObjects"</span>);</span><br><span class="line">        <span class="built_in">NSArray</span>* arrDistinct = [arrBooks valueForKeyPath:<span class="string">@"@distinctUnionOfObjects.price"</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSNumber</span> *price <span class="keyword">in</span> arrDistinct) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%f"</span>,price.floatValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"unionOfObjects"</span>);</span><br><span class="line">        <span class="built_in">NSArray</span>* arrUnion = [arrBooks valueForKeyPath:<span class="string">@"@unionOfObjects.price"</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSNumber</span> *price <span class="keyword">in</span> arrUnion) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%f"</span>,price.floatValue);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606011</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> <span class="selector-tag">distinctUnionOfObjects</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606506</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 10<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606564</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 20<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606583</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 30<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606621</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 40<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606654</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> <span class="selector-tag">unionOfObjects</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606694</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 40<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606704</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 20<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606712</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 30<span class="selector-class">.000000</span></span><br><span class="line">2017<span class="selector-tag">-01-17</span> 11<span class="selector-pseudo">:57</span><span class="selector-pseudo">:11.606719</span> <span class="selector-tag">TEST_OC</span><span class="selector-attr">[37189:3016637]</span> 10<span class="selector-class">.000000</span></span><br><span class="line"><span class="selector-tag">Program</span> <span class="selector-tag">ended</span> <span class="selector-tag">with</span> <span class="selector-tag">exit</span> <span class="selector-tag">code</span>: 0</span><br></pre></td></tr></table></figure>
<p>五、<strong>setValue:forKey:方法赋值的原理</strong></p>
<p>例如对于：[item setValue:@”value” forKey:@”property”]，具体实现为：</p>
<ol>
<li>首先去模型中查找有没有setProperty,找到,直接调用赋值 [self setProperty:@”value”]</li>
</ol>
<ol start="2">
<li>去模型中查找有没有property属性,有,直接访问属性赋值  property = value</li>
</ol>
<ol start="3">
<li>去模型中查找有没有_property属性,有,直接访问属性赋值 _property = value</li>
</ol>
<ol start="4">
<li>找不到,就会直接报错 setValue:forUndefinedKey:报找不到的错误</li>
</ol>
<p>如果开发者想让这个类禁用KVC里，那么重写+ (BOOL)accessInstanceVariablesDirectly方法让其返回NO即可，这样的话如果KVC没有找到set<key>:属性名时，会直接用setValue：forUNdefinedKey：方法。</key></p>
<p>所以，我们使用KVC要有以下三个条件：</p>
<ol>
<li>必须保证模型中定义的属性要大于或等于字典中key的数量。</li>
</ol>
<ol start="2">
<li>模型中的基本数据类型无法进行转换。</li>
</ol>
<ol start="3">
<li>属性的名字必须和键相同，否则找不到相关属性会报错。</li>
</ol>
<p>六、<strong>KVC异常处理</strong></p>
<p>KVC中最常见的异常就是不小心使用了错误的Key，或者在设值中不小心传递了nil的值，KVC中有专门的方法来处理这些异常。<br>通常在用KVC操作Model时，抛出异常的那两个方法是需要重写的。虽然一般很小出现传递了错误的Key值这种情况，但是如果不小心出现了，直接抛出异常让APP崩溃显然是不合理的。一般在这里直接让这个Key打印出来即可，或者有些特殊情况需要特殊处理。<br>通常情况下，KVC不允许你要在调用<em>setValue：属性值 forKey：@”name”</em>(或者keyPath)时对<strong>非对象</strong>传递一个nil的值。很简单，因为值类型是不能为nil的。如果你不小心传了，KVC会调用<em>setNilValueForKey:</em>方法。这个方法默认是抛出异常，所以一般而言最好还是重写这个方法。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[people1 <span class="built_in">set</span>Value:nil <span class="keyword">for</span>Key:@<span class="string">"age"</span>]</span><br><span class="line"></span><br><span class="line">*** Terminating app due <span class="keyword">to</span> uncaught exception 'NSInvalidArgumentException', reason: '[<span class="variable">&lt;People 0x100200080&gt;</span> <span class="built_in">set</span>NilValueForKey]: could not <span class="built_in">set</span> nil as the value <span class="keyword">for</span> the key age.' // 调用<span class="built_in">set</span>NilValueForKey抛出异常</span><br></pre></td></tr></table></figure>
<p>如果重写<em>setNilValueForKey:</em>就没问题了:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">People</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"不能将%@设成nil"</span>,key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>七、<strong>KVC和字典</strong></p>
<p>当对NSDictionary对象使用KVC时，<em>valueForKey:</em>的表现行为和<em>objectForKey:</em>一样。所以使用<em>valueForKeyPath:</em>用来访问多层嵌套的字典是比较方便的。</p>
<p>KVC里面还有两个关于NSDictionary的方法:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br><span class="line">- (<span class="keyword">void</span>)setValuesForKeysWithDictionary:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)keyedValues;</span><br></pre></td></tr></table></figure>
<p><code>dictionaryWithValuesForKeys:</code>是指输入一组key，返回这组key对应的属性，再组成一个字典。<br><code>setValuesForKeysWithDictionary</code>是用来修改Model中对应key的属性。下面直接用代码会更直观一点:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  main.m</span></span><br><span class="line"><span class="comment">//  TEST_OC</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by 李峰峰 on 2017/1/16.</span></span><br><span class="line"><span class="comment">//  Copyright © 2017年 李峰峰. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Address</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Address</span>()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span>* country;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span>* province;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span>* city;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">copy</span>)<span class="built_in">NSString</span>* district;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Address</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//模型转字典</span></span><br><span class="line">        Address* add = [Address new];</span><br><span class="line">        add.country = <span class="string">@"China"</span>;</span><br><span class="line">        add.province = <span class="string">@"Guang Dong"</span>;</span><br><span class="line">        add.city = <span class="string">@"Shen Zhen"</span>;</span><br><span class="line">        add.district = <span class="string">@"Nan Shan"</span>;</span><br><span class="line">        <span class="built_in">NSArray</span>* arr = @[<span class="string">@"country"</span>,<span class="string">@"province"</span>,<span class="string">@"city"</span>,<span class="string">@"district"</span>];</span><br><span class="line">        <span class="built_in">NSDictionary</span>* dict = [add dictionaryWithValuesForKeys:arr]; <span class="comment">//把对应key所有的属性全部取出来</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,dict);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//字典转模型</span></span><br><span class="line">        <span class="built_in">NSDictionary</span>* modifyDict = @&#123;<span class="string">@"country"</span>:<span class="string">@"USA"</span>,<span class="string">@"province"</span>:<span class="string">@"california"</span>,<span class="string">@"city"</span>:<span class="string">@"Los angle"</span>&#125;;</span><br><span class="line">        [add setValuesForKeysWithDictionary:modifyDict];            <span class="comment">//用key Value来修改Model的属性</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"country:%@  province:%@ city:%@"</span>,add.country,add.province,add.city);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打印结果：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">16</span> <span class="number">22</span>:<span class="number">53</span>:<span class="number">36.200448</span> TEST_OC[<span class="number">33394</span>:<span class="number">2683077</span>] &#123;</span><br><span class="line">    city = <span class="string">"Shen Zhen"</span>;</span><br><span class="line">    country = China;</span><br><span class="line">    district = <span class="string">"Nan Shan"</span>;</span><br><span class="line">    province = <span class="string">"Guang Dong"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">16</span> <span class="number">22</span>:<span class="number">53</span>:<span class="number">36.202199</span> TEST_OC[<span class="number">33394</span>:<span class="number">2683077</span>] country:USA  province:california city:Los angle</span><br><span class="line">Program ended with <span class="keyword">exit</span> code: <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>打印出来的结果完全符合预期。</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>imlifengfeng</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2017/01/16/493/">http://www.imlifengfeng.com/2017/01/16/493/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>原创文章，转载请注明来源</li></ul></div><br><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/KVC/">KVC</a></div><div class="post-nav"><a class="pre" href="/2017/01/17/498/">iOS KVO详解</a><a class="next" href="/2017/01/15/487/">iOS RunLoop详解</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'c364198c7db8ed6a1011',
  clientSecret: '7613c9d1c4706bdebff2c7adf84efdf98839ec7d',
  repo: 'imlifengfeng.github.io',
  owner: 'imlifengfeng',
  admin: ['imlifengfeng'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.imlifengfeng.com"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/03/714/">iOS 的组件化开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/06/692/">iOS逆向工程之fishhook</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/25/677/">iOS逆向工程之插件开发</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/03/674/">Swift算法实现之归并排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/672/">Swift算法实现之快速排序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/31/669/">Swift算法实现之翻转二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/31/661/">Swift算法实现之二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/28/658/">Swift算法实现之栈和队列</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/27/654/">Swift算法实现之查找第K大的元素</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/23/652/">Swift算法实现之数组中出现次数超过一半的数字</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">imlifengfeng.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>