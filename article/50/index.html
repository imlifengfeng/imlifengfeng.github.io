<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android实现微信自动抢红包 | 李峰峰博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-130566667-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bc022e1db553f2f9ac8145120b657824';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android实现微信自动抢红包</h1><a id="logo" href="/.">李峰峰博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android实现微信自动抢红包</h1><div class="post-meta">Dec 4, 2016<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h2><p>之前我写过实现QQ微信自动抢红包的APP，实现方法比较复杂。但是我最近偶然看到了一个实现自动抢红包更简单的方式，本文介绍这种微信自动抢红包的实现方法，掌握了相关方法后你也可以实现QQ抢红包，主要实现以下几个功能：</p>
<ul>
<li>自动拆开屏幕上出现的红包</li>
</ul>
<ul>
<li>处于桌面或聊天列表时接收到红包信息时自动进入聊天界面并拆红包</li>
</ul>
<ul>
<li>日志功能，记录抢红包的详细日志</li>
</ul>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h2><ul>
<li>利用AccessibilityService辅助服务，监测屏幕内容，实现自动拆红包的目的。</li>
</ul>
<ul>
<li>利用ActiveAndroid数据库简单记录红包日志</li>
</ul>
<ul>
<li>利用preference实现监控选项纪录</li>
</ul>
<h2 id="抢红包核心代码"><a href="#抢红包核心代码" class="headerlink" title="抢红包核心代码"></a><strong>抢红包核心代码</strong></h2><h3 id="AccessibilityService配置"><a href="#AccessibilityService配置" class="headerlink" title="AccessibilityService配置"></a><strong>AccessibilityService配置</strong></h3><p>android:accessibilityEventTypes 设置触发监听回调的事件类型；<br>android:packageNames 设置监听的应用，这里监听的是微信，因此填上微信的包名com.tencent.mm</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;accessibility-service xmlns:<span class="attribute">android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">android:<span class="attribute">accessibilityEventTypes</span>=<span class="string">"typeNotificationStateChanged|typeWindowStateChanged|typeWindowContentChanged"</span></span><br><span class="line">    android:<span class="attribute">accessibilityFeedbackType</span>=<span class="string">"feedbackGeneric"</span></span><br><span class="line">    android:<span class="attribute">accessibilityFlags</span>=<span class="string">"flagDefault"</span></span><br><span class="line">    android:<span class="attribute">canRetrieveWindowContent</span>=<span class="string">"true"</span></span><br><span class="line">    android:<span class="attribute">description</span>=<span class="string">"@string/accessibility_description"</span></span><br><span class="line">    android:<span class="attribute">notificationTimeout</span>=<span class="string">"100"</span></span><br><span class="line">    android:<span class="attribute">packageNames</span>=<span class="string">"com.tencent.mm"</span></span><br><span class="line"> android:<span class="attribute">settingsActivity</span>=<span class="string">"com.oden.annotations.app.activity.ManActivity"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>在AndroidManifest.xml中声明:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:name</span>=<span class="string">".app.service.HongbaoService_"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:exported</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">android:permission</span>=<span class="string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span> &gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice.AccessibilityService"</span> /&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">               <span class="attr">android:name</span>=<span class="string">"android.accessibilityservice"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:resource</span>=<span class="string">"@xml/accessibility_service_config"</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="抢红包实现代码"><a href="#抢红包实现代码" class="headerlink" title="抢红包实现代码"></a><strong>抢红包实现代码</strong></h3><p>接收系统发送来的AccessibilityEvent</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> GET_RED_PACKET = <span class="string">"领取红包"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> CHECK_RED_PACKET = <span class="string">"查看红包"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> RED_PACKET_PICKED = <span class="string">"手慢了，红包派完了"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> RED_PACKET_PICKED2 = <span class="string">"手气"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> RED_PACKET_PICKED_DETAIL = <span class="string">"红包详情"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> RED_PACKET_SAVE = <span class="string">"已存入零钱"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> RED_PACKET_NOTIFICATION = <span class="string">"[微信红包]"</span>;</span><br><span class="line"></span><br><span class="line"> @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onAccessibilityEvent(AccessibilityEvent event) &#123;</span><br><span class="line">        L.d(<span class="string">"RECEIVE EVENT!"</span>);</span><br><span class="line">        <span class="keyword">if</span> (watchedFlags == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">         <span class="comment">/* 检测通知消息 */</span></span><br><span class="line">        <span class="keyword">if</span> (!mMutex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (watchedFlags.<span class="built_in">get</span>(<span class="string">"pref_watch_notification"</span>) &amp;&amp; watchNotifications(event)) <span class="keyword">return</span>;</span><br><span class="line">            <span class="keyword">if</span> (watchedFlags.<span class="built_in">get</span>(<span class="string">"pref_watch_list"</span>) &amp;&amp; watchList(event)) <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!watchedFlags.<span class="built_in">get</span>(<span class="string">"pref_watch_chat"</span>)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.rootNodeInfo = event.getSource();</span><br><span class="line">        <span class="keyword">if</span> (rootNodeInfo == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        mReceiveNode = <span class="keyword">null</span>;</span><br><span class="line">        mUnpackNode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        checkNodeInfo();</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* 如果已经接收到红包并且还没有戳开 */</span></span><br><span class="line">        <span class="keyword">if</span> (mLuckyMoneyReceived &amp;&amp; !mLuckyMoneyPicked &amp;&amp; (mReceiveNode != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            mMutex = <span class="keyword">true</span>;</span><br><span class="line">            AccessibilityNodeInfo cellNode = mReceiveNode;</span><br><span class="line">            cellNode.getParent().performAction(AccessibilityNodeInfo.ACTION_CLICK);</span><br><span class="line">            mLuckyMoneyReceived = <span class="keyword">false</span>;</span><br><span class="line">            mLuckyMoneyPicked = <span class="keyword">true</span>;</span><br><span class="line">            L.d(<span class="string">"正在打开！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* 如果戳开但还未领取 */</span></span><br><span class="line">        <span class="keyword">if</span> (mNeedUnpack &amp;&amp; (mUnpackNode != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            AccessibilityNodeInfo cellNode = mUnpackNode;</span><br><span class="line">            cellNode.performAction(AccessibilityNodeInfo.ACTION_CLICK);</span><br><span class="line">            mNeedUnpack = <span class="keyword">false</span>;</span><br><span class="line">            L.d(<span class="string">"正在领取！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mNeedBack) &#123;</span><br><span class="line">            performGlobalAction(GLOBAL_ACTION_BACK);</span><br><span class="line">            mMutex = <span class="keyword">false</span>;</span><br><span class="line">            mNeedBack = <span class="keyword">false</span>;</span><br><span class="line">            L.d(<span class="string">"正在返回！"</span>);</span><br><span class="line">            <span class="comment">//总次数和金额统计</span></span><br><span class="line">            <span class="keyword">if</span> (isGetMoney) &#123;</span><br><span class="line">                T.showShort(<span class="keyword">this</span>, <span class="string">"抢到一个红包: "</span> + gotMoney + <span class="string">"元!"</span>);</span><br><span class="line">                totalMoney = totalMoney + gotMoney;</span><br><span class="line">                totalSuccessNum++;</span><br><span class="line">                myPrefs.totalMoney().put(totalMoney);</span><br><span class="line">                myPrefs.successNum().put(totalSuccessNum);</span><br><span class="line">                L.d(<span class="string">"totalMoney: "</span> + totalMoney);</span><br><span class="line">                L.d(<span class="string">"totalSuccessNum: "</span> + totalSuccessNum);</span><br><span class="line">                saveToLog(hongbaoInfo);</span><br><span class="line">                isGetMoney = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>检测监听事件的节点信息</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void checkNodeInfo() &#123;</span><br><span class="line">        L.d(<span class="string">"checkNodeInfo!"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.rootNodeInfo == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">         <span class="comment">/* 聊天会话窗口，遍历节点匹配“领取红包”和"查看红包" */</span></span><br><span class="line">        List&lt;AccessibilityNodeInfo&gt; nodes1 = <span class="keyword">this</span>.findAccessibilityNodeInfosByTexts(<span class="keyword">this</span>.rootNodeInfo, new String[]&#123;</span><br><span class="line">                GET_RED_PACKET, CHECK_RED_PACKET&#125;);</span><br><span class="line">        <span class="keyword">if</span> (!nodes1.isEmpty()) &#123;</span><br><span class="line">        L.d(<span class="string">"!nodes1.isEmpty()"</span>);</span><br><span class="line">            AccessibilityNodeInfo targetNode = nodes1.<span class="keyword">get</span>(nodes1.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"android.widget.LinearLayout"</span>.equals(targetNode.getParent().getClassName()))<span class="comment">//避免被文字干扰导致外挂失效</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.signature.generateSignature(targetNode)) &#123;</span><br><span class="line">                    mLuckyMoneyReceived = <span class="literal">true</span>;</span><br><span class="line">                    mReceiveNode = targetNode;</span><br><span class="line">                    L.d(<span class="string">"signature:"</span> + <span class="keyword">this</span>.signature.toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                L.d(<span class="string">"this is text"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;AccessibilityNodeInfo&gt; nodes2 = <span class="keyword">this</span>.findAccessibilityNodeInfosByTexts(<span class="keyword">this</span>.rootNodeInfo, new String[]&#123;</span><br><span class="line">                <span class="string">"拆红包"</span>&#125;);</span><br><span class="line">        <span class="keyword">if</span> (!nodes2.isEmpty()) &#123;</span><br><span class="line">            L.d(<span class="string">"node2 != null"</span>);</span><br><span class="line">            <span class="keyword">for</span> (AccessibilityNodeInfo nodeInfo : nodes2) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (nodeInfo.getClassName().equals(<span class="string">"android.widget.Button"</span>))</span><br><span class="line">                        nodeInfo.performAction(AccessibilityNodeInfo.ACTION_CLICK);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">/* 戳开红包，红包还没抢完，遍历节点匹配“拆红包” */</span></span><br><span class="line">            AccessibilityNodeInfo node2 = (<span class="keyword">this</span>.rootNodeInfo.getChildCount() &gt; <span class="number">3</span>) ? <span class="keyword">this</span>.rootNodeInfo.getChild(<span class="number">3</span>) : <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (node2 != <span class="literal">null</span> &amp;&amp; node2.getClassName().equals(<span class="string">"android.widget.Button"</span>)) &#123;</span><br><span class="line">                mUnpackNode = node2;</span><br><span class="line">                mNeedUnpack = <span class="literal">true</span>;</span><br><span class="line">                isToGetMoney = <span class="literal">true</span>;</span><br><span class="line">                L.d(<span class="string">"find red packet!"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">/* 戳开红包，红包已被抢完，遍历节点匹配“已存入零钱”和“手慢了” */</span></span><br><span class="line">        <span class="keyword">if</span> (mLuckyMoneyPicked) &#123;</span><br><span class="line">            List&lt;AccessibilityNodeInfo&gt; nodes3 = <span class="keyword">this</span>.findAccessibilityNodeInfosByTexts(<span class="keyword">this</span>.rootNodeInfo, new String[]&#123;</span><br><span class="line">                    RED_PACKET_PICKED, RED_PACKET_SAVE, RED_PACKET_PICKED2, RED_PACKET_PICKED_DETAIL&#125;);</span><br><span class="line">            <span class="keyword">if</span> (!nodes3.isEmpty()) &#123;</span><br><span class="line">                L.d(<span class="string">"!nodes3.isEmpty()"</span>);                </span><br><span class="line">                <span class="keyword">if</span> (rootNodeInfo.getChildCount() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    L.d(<span class="string">"RED_PACKET_PICKED!"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    L.d(<span class="string">"nodes3.get(0).toString(): "</span> + nodes3.<span class="keyword">get</span>(<span class="number">0</span>).getText().toString());</span><br><span class="line">                    <span class="keyword">if</span> (!nodes3.<span class="keyword">get</span>(<span class="number">0</span>).getText().toString().equals(RED_PACKET_PICKED_DETAIL)) &#123;</span><br><span class="line">                        AccessibilityNodeInfo targetNode = nodes3.<span class="keyword">get</span>(nodes3.size() - <span class="number">1</span>);</span><br><span class="line">                        hongbaoInfo.getInfo(targetNode);</span><br><span class="line">                        <span class="keyword">if</span> (isToGetMoney) &#123;</span><br><span class="line">                            isGetMoney = <span class="literal">true</span>;</span><br><span class="line">                            isToGetMoney = <span class="literal">false</span>;</span><br><span class="line">                            gotMoney = hongbaoInfo.getMoney();</span><br><span class="line">                            L.d(<span class="string">"gotMoney: "</span> + gotMoney);</span><br><span class="line">                        &#125;</span><br><span class="line">                        L.d(<span class="string">"RED_PACKET_SAVE!"</span>);</span><br><span class="line">                        L.d(<span class="string">"hongbaoInfo: "</span> + hongbaoInfo.toString());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        L.d(<span class="string">"this packet is myself!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                mNeedBack = <span class="literal">true</span>;</span><br><span class="line">                mLuckyMoneyPicked = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>主要通过检测“领取红包”等关键文字信息来判断是否有新红包</li>
</ul>
<ul>
<li>检测收到红包时判断是否”android.widget.LinearLayout”，屏蔽聊天信息中的文字干扰</li>
</ul>
<ul>
<li>拆红包时，由于微信版本可能不同，同时进行两种判断，以兼容部分版本</li>
</ul>
<ul>
<li>拆完红包需自动返回，有以下几种情况：抢到了，手慢了，以及该红包是自己发出的红包</li>
</ul>
<p>下面是监听聊天列表的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">watchList</span>(<span class="params">AccessibilityEvent <span class="keyword">event</span></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Not a message</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">event</span>.getEventType() != AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED || <span class="keyword">event</span>.getSource() == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;AccessibilityNodeInfo&gt; nodes = <span class="keyword">event</span>.getSource().findAccessibilityNodeInfosByText(RED_PACKET_NOTIFICATION);</span><br><span class="line">        <span class="keyword">if</span> (!nodes.isEmpty()) &#123;</span><br><span class="line">            AccessibilityNodeInfo nodeToClick = nodes.<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">            CharSequence contentDescription = nodeToClick.getContentDescription();</span><br><span class="line">            <span class="keyword">if</span> (contentDescription != <span class="literal">null</span> &amp;&amp; !lastContentDescription.<span class="keyword">equals</span>(contentDescription)) &#123;</span><br><span class="line">                nodeToClick.performAction(AccessibilityNodeInfo.ACTION_CLICK);</span><br><span class="line">                lastContentDescription = contentDescription.toString();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code></code>下面是监听通知信息的代码：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> boolean <span class="title">watchNotifications</span>(<span class="params">AccessibilityEvent <span class="keyword">event</span></span>)</span> &#123;</span><br><span class="line">       <span class="comment">// Not a notification</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">event</span>.getEventType() != AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED)</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Not a hongbao</span></span><br><span class="line">       String tip = <span class="keyword">event</span>.getText().toString();</span><br><span class="line">       <span class="keyword">if</span> (!tip.contains(RED_PACKET_NOTIFICATION)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">       Parcelable parcelable = <span class="keyword">event</span>.getParcelableData();</span><br><span class="line">       <span class="keyword">if</span> (parcelable instanceof Notification) &#123;</span><br><span class="line">           Notification notification = (Notification) parcelable;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               notification.contentIntent.send();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="红包信息的获取，及日志的存储"><a href="#红包信息的获取，及日志的存储" class="headerlink" title="红包信息的获取，及日志的存储"></a><strong>红包信息的获取，及日志的存储</strong></h3><p>通过获取节点的子信息，分别获得红包发送者及抢到的金额、抢红包时间等信息，建立简单的表单分别记录该信息。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">Table</span>(name = <span class="string">"HongbaoInfos"</span>)</span><br><span class="line"><span class="keyword">public</span> class HongbaoInfo extends Model &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> <span class="built_in">month</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> <span class="built_in">day</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> <span class="built_in">hour</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> <span class="built_in">min</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> sec;</span><br><span class="line"></span><br><span class="line">    @Column(name = <span class="string">"sender"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> sender;</span><br><span class="line"></span><br><span class="line">    @Column(name = <span class="string">"money"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> money;</span><br><span class="line"></span><br><span class="line">    @Column(name = <span class="string">"time"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> getInfo(AccessibilityNodeInfo node) &#123;</span><br><span class="line"></span><br><span class="line">        AccessibilityNodeInfo hongbaoNode = node.getParent();</span><br><span class="line">        sender = hongbaoNode.getChild(<span class="number">0</span>).getText().toString();</span><br><span class="line">        money = hongbaoNode.getChild(<span class="number">2</span>).getText().toString();</span><br><span class="line">        time = getStringTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> getStringTime() &#123;</span><br><span class="line">        Calendar c = Calendar.getInstance();</span><br><span class="line">        <span class="built_in">month</span> = c.<span class="built_in">get</span>(Calendar.MONTH) + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">day</span> = c.<span class="built_in">get</span>(Calendar.DAY_OF_MONTH);</span><br><span class="line">        <span class="built_in">hour</span> = c.<span class="built_in">get</span>(Calendar.HOUR_OF_DAY);</span><br><span class="line">        <span class="built_in">min</span> = c.<span class="built_in">get</span>(Calendar.MINUTE);</span><br><span class="line">        sec = c.<span class="built_in">get</span>(Calendar.SECOND);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">month</span>+<span class="string">"月"</span>+<span class="built_in">day</span>+<span class="string">"日  "</span>+<span class="built_in">hour</span>+<span class="string">":"</span>+<span class="built_in">min</span>+<span class="string">":"</span>+sec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> toString() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"HongbaoInfo [sender="</span> + sender + <span class="string">", money="</span> + money + <span class="string">", time="</span> + time + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;HongbaoInfo&gt; getAll() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Select()</span><br><span class="line">                .from(HongbaoInfo.class)</span><br><span class="line">                .orderBy(<span class="string">"Id ASC"</span>)</span><br><span class="line">                .execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> deleteALL() &#123;</span><br><span class="line">        <span class="keyword">new</span> Delete().from(HongbaoInfo.class).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> getMoney() &#123;</span><br><span class="line">        <span class="keyword">return</span> Float.parseFloat(money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> getSender() &#123;</span><br><span class="line">        <span class="keyword">return</span> sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">String</span> getTime() &#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>存储操作：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveToLog</span>(<span class="params">HongbaoInfo hongbaoInfo</span>)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (watchedFlags.<span class="keyword">get</span>(<span class="string">"pref_etc_log"</span>)) &#123;</span><br><span class="line">           HongbaoInfo hongbaoInfo1 = <span class="keyword">new</span> HongbaoInfo();</span><br><span class="line">           hongbaoInfo1 = hongbaoInfo;</span><br><span class="line">           hongbaoInfo1.save();</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           L.d(<span class="string">"log closed!"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>主要的代码到这里基本结束，目前在微信最新版上测试ok，尚还存在以下几个问题：</p>
<ul>
<li>同一个人连续发的不能自动抢，因为为了防止重复点击做了过滤，同一个人的红包抢了后不会再次点击</li>
</ul>
<ul>
<li>AccessibilityService开启时间长后有时会被系统关掉</li>
</ul>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>imlifengfeng</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/article/50/">https://imlifengfeng.github.io/article/50/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>原创文章，转载请注明来源</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://imlifengfeng.github.io/article/50/" data-id="cjpc8qs8e00644ts6s0t2frlj" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABxElEQVR42u3aQW7DMAwEwPz/0ymQaypnKdqMA4xPBqpK4xwIaqXHI36er+f9fTXyeEwyT+vBxcVtc5+Hz4q7GrPiJvMfj8HFxZ3nJsUrKVIraP7+wYaLi3szbr8xSgolLi7ub3GPC1n+Sbi4uL/CzTcnSfyRb4Qu3Kvh4uI2uJ3A9Kz3oXwXFxe3fSpRDUY7kWu0Oi4u7gg3iTiTA9RqnJq3UOVEFhcXt81NBuWlKr9+sfdJuLi4M9x+iJkXtb3GqFXUcHFxT+Xm6Oo1rP4FL1xc3Ku5m1/WuGJViD/ehbi4uIPc/OJFtVRVr19EtRYXF/er3PygNAlTkogWFxf3ztzOoWknWv2wFi4u7pe4VVB1a9Rps3BxcSe51YX3rmt0bojg4uJOcvugs2LWwg+Ei4t7Mbd6UFqNQvLtUNRa4eLiDnL3Ni3VA5Vktg/RLS4u7iC3ejGiuqVJil30Mbi4uCPcakHJQXubnE5JxcXFPZebF69qy1ItiFHUgouLO8ittiPntj6FHwIXF/dm3OP/SopRtQH656+4uLg35ibHKp3AZbkuLi7uIHdvok4wWp0BFxd3krsXmOZtUHWxvA3CxcW9gPsHDF/dRBau9NMAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/抢红包/">抢红包</a></div><div class="post-nav"><a class="pre" href="/article/390/">iOS Runtime之一：Class和meta-class</a><a class="next" href="/article/32/">iOS单元测试详解</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'c364198c7db8ed6a1011',
  clientSecret: '7613c9d1c4706bdebff2c7adf84efdf98839ec7d',
  repo: 'imlifengfeng.github.io',
  owner: 'imlifengfeng',
  admin: ['imlifengfeng'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/article/714/">iOS 的组件化开发</a></li><li class="post-list-item"><a class="post-list-link" href="/article/692/">iOS逆向工程之fishhook</a></li><li class="post-list-item"><a class="post-list-link" href="/article/677/">iOS逆向工程之插件开发</a></li><li class="post-list-item"><a class="post-list-link" href="/article/674/">Swift算法实现之归并排序</a></li><li class="post-list-item"><a class="post-list-link" href="/article/672/">Swift算法实现之快速排序</a></li><li class="post-list-item"><a class="post-list-link" href="/article/669/">Swift算法实现之翻转二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/article/661/">Swift算法实现之二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/article/658/">Swift算法实现之栈和队列</a></li><li class="post-list-item"><a class="post-list-link" href="/article/654/">Swift算法实现之查找第K大的元素</a></li><li class="post-list-item"><a class="post-list-link" href="/article/652/">Swift算法实现之数组中出现次数超过一半的数字</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">李峰峰博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>