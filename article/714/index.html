<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>iOS 的组件化开发 | 李峰峰博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-130566667-1','auto');ga('send','pageview');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'bc022e1db553f2f9ac8145120b657824';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">iOS 的组件化开发</h1><a id="logo" href="/.">李峰峰博客</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">iOS 的组件化开发</h1><div class="post-meta">Oct 3, 2018<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a></span></div><div class="post-content"><p>在一个APP开发过程中，如果项目较小且团队人数较少，使用最基本的MVC、MVVM开发就已经足够了，因为维护成本比较低。</p>
<p>但是当一个项目开发团队人数较多时，因为每个人都会负责相应组件的开发，常规开发模式耦合会越来越严重，而且导致大量代码冲突，会使后期维护和升级过程中代码“牵一发而动全身”，额外带来很大的工作量，并且会导致一些潜在的BUG。</p>
<p>在这时，组件化开发就派上很大用场了，所谓的组件化开发，就是把APP根据业务拆分为各独立的组件，各个组件相互写作，组成完整的APP。</p>
<h3 id="一、各组件的引入"><a href="#一、各组件的引入" class="headerlink" title="一、各组件的引入"></a>一、各组件的引入</h3><p>关于组件的拆分，就根据具体项目进行拆分，假如APP被拆分了AModule、BModule、CModule，那么，应该如何引入这些组件呢？你可能会想到APP的入口AppDelegate。在平时开发中，AppDelegate中往往初始化了好多组件，比如推送、统计等组件，这样就会导致AppDelegate的臃肿。</p>
<p>所以，我们可以增加一个ModuleManager，专门用来初始化各组件。<br>首先增加一个 ModuleProtocol：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="keyword">@import</span> <span class="built_in">UIKit</span>;</span><br><span class="line"><span class="keyword">@import</span> UserNotifications;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">ModuleProtocol</span> &lt;<span class="title">UIApplicationDelegate</span>, <span class="title">UNUserNotificationCenterDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>我们在ModuleManager中hook住UIApplicationDelegate和 UNUserNotificationCenterDelegate中的方法，使相应的组件中实现了对应方法，在相应时机就会调用组建里的对应方法：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ModuleManager.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define ALL_MODULE [[ModuleManager sharedInstance] allModules]</span></span><br><span class="line"><span class="meta">#define SWIZZLE_METHOD(m) swizzleMethod(class, @selector(m),@selector(module_##m));</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ModuleManager</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableArray</span>&lt;<span class="keyword">id</span>&lt;ModuleProtocol&gt;&gt; *modules;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ModuleManager</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableArray</span>&lt;<span class="keyword">id</span>&lt;ModuleProtocol&gt;&gt; *)modules &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addModule:(<span class="keyword">id</span>&lt;ModuleProtocol&gt;) module &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)loadModulesWithPlistFile:(<span class="built_in">NSString</span> *)plistFile &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="keyword">id</span>&lt;ModuleProtocol&gt;&gt; *)allModules &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span> (<span class="title">Module</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class <span class="keyword">class</span> = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">        SWIZZLE_METHOD(application:willFinishLaunchingWithOptions:);</span><br><span class="line">        SWIZZLE_METHOD(application:didFinishLaunchingWithOptions:);</span><br><span class="line">        ......</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> swizzleMethod(Class <span class="keyword">class</span>, SEL originalSelector, SEL swizzledSelector) &#123; ...... &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)module_application:(<span class="built_in">UIApplication</span> *)application willFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> result = [<span class="keyword">self</span> module_application:application willFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span>&lt;ModuleProtocol&gt; module <span class="keyword">in</span> ALL_MODULE) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([module respondsToSelector:_cmd]) &#123;</span><br><span class="line">            [module application:application willFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)module_application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> result = [<span class="keyword">self</span> module_application:application didFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span>&lt;ModuleProtocol&gt; module <span class="keyword">in</span> ALL_MODULE) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([module respondsToSelector:_cmd]) &#123;</span><br><span class="line">            [module application:application didFinishLaunchingWithOptions:launchOptions];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>ModuleManager.h:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ModuleProtocol.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ModuleManager</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)sharedInstance;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)loadModulesWithPlistFile:(<span class="built_in">NSString</span> *)plistFile;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span>&lt;<span class="keyword">id</span>&lt;ModuleProtocol&gt;&gt; *)allModules;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>之后我们通过一个 ModulesRegister.plist文件管理需要引入的组件：</p>
<p>如上图，假如我们要引入AModule、BModule、CModule，那么这三个Module只需要实现协议ModuleProtocol，然后实现AppDelegate中对应的方法，在对应方法中初始化自身即可：<br>AModule.h:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"ModuleProtocol.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AModule</span> : <span class="title">NSObject</span>&lt;<span class="title">ModuleProtocol</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>AModule.m:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"AModule.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AModule</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions&#123;</span><br><span class="line">    <span class="comment">//初始化AModule</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>之后在AppDelegate的load方法中通过ModulesRegister.plist引入各组件即可：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AppDelegate</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">//load modules</span></span><br><span class="line">    <span class="built_in">NSString</span>* plistPath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"ModulesRegister"</span> ofType:<span class="string">@"plist"</span>];</span><br><span class="line">    [[ModuleManager sharedInstance] loadModulesWithPlistFile:plistPath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>这样，各组件的开发者在自己的组件中初始化自己，其他人需要使用时只需要加入ModulesRegister.plist文件中即可。</p>
<h3 id="二、组件间协作"><a href="#二、组件间协作" class="headerlink" title="二、组件间协作"></a>二、组件间协作</h3><p>简单来看，假设APP的每个页面就是一个组件，假如我们的APP有AViewController、BViewController、CViewController、DViewController、EViewController，各ViewController必然设置各种相互跳转。那么，我们APP的跳转逻辑可能是下面这个样子：</p>
<p>为了解决这种复杂的耦合关系，我们可以增加一个Router中间层去管理各ViewController之间的跳转关系（也就是实际开发中组件间相互调用的关系）。</p>
<p>所以，根据需要，我开发并开源了一个支持URL Rewrite的iOS路由库— <a href="https://github.com/imlifengfeng/FFRouter" target="_blank" rel="noopener">FFRouter</a>，通过<a href="https://github.com/imlifengfeng/FFRouter" target="_blank" rel="noopener">FFRouter</a>去管理各ViewController之间的跳转关系：</p>
<p>这样，各ViewController之间的跳转关系就变的清晰了许多。</p>
<p>FFRouter通过提前注册对应的URL，之后就直接通过打开URL去控制各ViewController之间的跳转（或各组件间的调用）。<br>FFRouter支持组件间传递非常规对象，如UIImage等，并支持获取组件返回值。<br>基本使用如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 注册 url</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> routeURL 要注册的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> handlerBlock URL 被 Route 后的回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">registerRouteURL:</span>(NSString *)routeURL <span class="string">handler:</span>(FFRouterHandler)handlerBlock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 注册 URL,通过该方式注册的 URL 被 Route 后可返回一个 Object</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> routeURL 要注册的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> handlerBlock URL 被 Route 后的回调,可在回调中返回一个 Object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">registerObjectRouteURL:</span>(NSString *)routeURL <span class="string">handler:</span>(FFObjectRouterHandler)handlerBlock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 判断 URL 是否可被 Route（是否已经注册）</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要判断的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@return</span> 是否可被 Route</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (BOOL)<span class="string">canRouteURL:</span>(NSString *)URL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Route 一个 URL</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要 Router 的 URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">routeURL:</span>(NSString *)URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Route 一个 URL，并带上额外参数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要 Router 的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> parameters 额外参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">routeURL:</span>(NSString *)URL <span class="string">withParameters:</span>(NSDictionary&lt;NSString *, id&gt; *)parameters;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Route 一个 URL，可获得返回的 Object</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要 Router 的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@return</span> 返回的 Object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (id)<span class="string">routeObjectURL:</span>(NSString *)URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Route 一个 URL，并带上额外参数，可获得返回的 Object</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要 Router 的 URL</span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> parameters 额外参数</span></span><br><span class="line"><span class="comment"> <span class="doctag">@return</span> 返回的 Object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (id)<span class="string">routeObjectURL:</span>(NSString *)URL <span class="string">withParameters:</span>(NSDictionary&lt;NSString *, id&gt; *)parameters;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Route 一个未注册 URL 时回调</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> handler 回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">routeUnregisterURLHandler:</span>(FFRouterUnregisterURLHandler)handler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 取消注册某个 URL</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> URL 要被取消注册的 URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">unregisterRouteURL:</span>(NSString *)URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 取消注册所有 URL</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)unregisterAllRoutes;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 是否显示 Log，用于调试</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> <span class="doctag">@param</span> enable YES or NO，默认为 NO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)<span class="string">setLogEnabled:</span>(BOOL)enable;</span><br></pre></td></tr></table></figure>
<p>而且参考天猫的方案增加了URL Rewrite功能：</p>
<p>可以使用正则添加一条 Rewrite 规则，例如：<br>要实现打开 URL:<a href="https://www.taobao.com/search/原子弹时，将其拦截，改用本地已注册的" target="_blank" rel="noopener">https://www.taobao.com/search/原子弹时，将其拦截，改用本地已注册的</a> URL:protocol://page/routerDetails?product=原子弹打开。<br>首先添加一条 Rewrite 规则：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[FFRouterRewrite <span class="string">addRewriteMatchRule:</span>@<span class="string">"(?:https://)?www.taobao.com/search/(.*)"</span> <span class="string">targetRule:</span>@<span class="string">"protocol://page/routerDetails?product=$1"</span>];</span><br></pre></td></tr></table></figure>
<p>之后在打开URL:<a href="https://www.taobao.com/search/原子弹时，将会" target="_blank" rel="noopener">https://www.taobao.com/search/原子弹时，将会</a> Rewrite 到URL:protocol://page/routerDetails?product=原子弹。</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="name">FFRouter</span> routeURL:@<span class="string">"https://www.taobao.com/search/原子弹"</span>]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>可以通过以下方法同时增加多个规则：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)addRewriteRules:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSDictionary</span> *&gt; *)rules;</span><br></pre></td></tr></table></figure>
<p>其中 rules 格式必须为以下格式：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@[</span><span class="meta">@&#123;</span><span class="meta">@"matchRule":</span><span class="meta">@"YourMatchRule1",</span><span class="meta">@"targetRule":</span><span class="meta">@"YourTargetRule1"&#125;,</span></span><br><span class="line">  <span class="meta">@&#123;</span><span class="meta">@"matchRule":</span><span class="meta">@"YourMatchRule2",</span><span class="meta">@"targetRule":</span><span class="meta">@"YourTargetRule2"&#125;,</span></span><br><span class="line">  <span class="meta">@&#123;</span><span class="meta">@"matchRule":</span><span class="meta">@"YourMatchRule3",</span><span class="meta">@"targetRule":</span><span class="meta">@"YourTargetRule3"&#125;,]</span></span><br></pre></td></tr></table></figure>
<p>Rewrite 规则中的保留字：</p>
<ul>
<li>通过 <em><strong>$scheme</strong></em>、<em><strong>$host</strong></em>、<em><strong>$port</strong></em>、<em><strong>$path</strong></em>、<em><strong>$query</strong></em>、<em><strong>$fragment</strong></em> 获取标准 URL 中的相应部分。通过<em><strong>$url</strong></em>获取完整 URL</li>
</ul>
<ul>
<li>通过 <em><strong>$1</strong></em>、<em><strong>$2</strong></em>、<em><strong>$3</strong></em>…获取matchRule的正则中使用圆括号取出的参数</li>
</ul>
<ul>
<li><em><strong>$</strong></em>：原变量的值、<em><strong>$$</strong></em>：原变量URL Encode后的值、<em><strong>$#</strong></em>：原变量URL Decode后的值</li>
</ul>
<p>例如：<br><a href="https://www.taobao.com/search/原子弹对于Rewrite" target="_blank" rel="noopener">https://www.taobao.com/search/原子弹对于Rewrite</a> 规则(?:https://)?<a href="http://www.taobao.com/search/(.*)" target="_blank" rel="noopener">www.taobao.com/search/(.*)</a></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$1=原子弹</span><br><span class="line">$$<span class="number">1</span>=%e5%8e%9f%e5%ad%90%e5%bc%b9</span><br></pre></td></tr></table></figure>
<p>同样，<a href="https://www.taobao.com/search/%e5%8e%9f%e5%ad%90%e5%bc%b9对于Rewrite" target="_blank" rel="noopener">https://www.taobao.com/search/%e5%8e%9f%e5%ad%90%e5%bc%b9对于Rewrite</a> 规则(?:https://)?<a href="http://www.taobao.com/search/(.*)" target="_blank" rel="noopener">www.taobao.com/search/(.*)</a></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$1=%e5%8e%9f%e5%ad%90%e5%bc%b9</span><br><span class="line">$#1=原子弹</span><br></pre></td></tr></table></figure>
<p>考虑到经常用路由配置UIViewController之间的跳转，所以增加了额外的工具FFRouterNavigation来更方便地控制UIViewController之间的跳转。</p>
<h3 id="三、其他组件化方案"><a href="#三、其他组件化方案" class="headerlink" title="三、其他组件化方案"></a>三、其他组件化方案</h3><p>目前这种组件化方案参考了蘑菇街、天猫、京东的的实现方案。除这种方案外，Casa（<a href="https://casatwy.com/iOS-Modulization.html" target="_blank" rel="noopener">查看文章</a>）之前提出了解耦程度更高的方案，这种方案组件仍然使用中间件通信，但中间件通过 runtime 接口解耦，然后使用 target-action 简化写法，通过 category 分离组件接口代码。<br>但是，这种方案虽然解耦程度更高，但是也增加了组件化的成本，综合考虑，直接使用中间件通信的方式更好一点。具体哪种方案好，也就仁者见仁、智者见智了～</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>imlifengfeng</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/article/714/">https://imlifengfeng.github.io/article/714/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>原创文章，转载请注明来源</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://imlifengfeng.github.io/article/714/" data-id="cjpc8qs8n00704ts6rmrmn9wp" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLUlEQVR42u3ay27DMAxEUf//TzvbAI2lmaFcQNTVqghSmycLQnxcl3zur/P3k6fz/c3xk5/esvjAgAFjW4Yeyji4pyCU5zw9WYkNBgwY5zCUVKin46cgsrQ+jg0GDBgw3KSpJEc34cKAAQNGxlASsZ523QIYBgwYZzKylplyKcwumi/W4jBgwNiQoXfd///vV+YbMGDA2Ipxm0dJiJXB5B0dGDBg9GZkhagCqMCyeGDAgNGbkW1Y6Y1+t7k2HiQsuzLCgAFjE0Z2gcsGjVkKVhbRYMCA0ZvxRnO/UrLq18TJfAMGDBhNGcpX3QuiHq77FqMWhwEDxuaMbAxQScrZ8sSCthoMGDBaMCqLEXqpmRWxkxIXBgwYBzDctlrWRFuV0H98DgMGjNYMd7khKzjHJP2Nk/+FAQPGAQz9lW47rL6oIQ1WYcCAcQDDXm4wSfon7tthwIDRm6GvmbolbnYR1JfSYMCAcRoja4RlCbfSYrOXLWDAgNGCoZSI2UjSaJPJBXapawgDBowWjNJiljkGyAaZk6hgwIBxAMNNcJVFsawxd9V/RRgwYGzOUIKuDCPXUidXQxgwYDRi3ObRg6iEZbf/YMCA0ZqRtb3sRpiZZOvFLQwYMPox9CTrttXc62NpkAADBowDGHriy9KiXgBn0cKAAQNGduFTVr5WPRkGDBgw1l4HdaTydhgwYJzDcIcBykpEthCWNe9gwIDRm1EqHc1aUmnn6UkWBgwYBzA+7dosusOdv+MAAAAASUVORK5CYII=">分享</a><div class="tags"></div><div class="post-nav"><a class="next" href="/article/692/">iOS逆向工程之fishhook</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'c364198c7db8ed6a1011',
  clientSecret: '7613c9d1c4706bdebff2c7adf84efdf98839ec7d',
  repo: 'imlifengfeng.github.io',
  owner: 'imlifengfeng',
  admin: ['imlifengfeng'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/教程/">教程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/article/714/">iOS 的组件化开发</a></li><li class="post-list-item"><a class="post-list-link" href="/article/692/">iOS逆向工程之fishhook</a></li><li class="post-list-item"><a class="post-list-link" href="/article/677/">iOS逆向工程之插件开发</a></li><li class="post-list-item"><a class="post-list-link" href="/article/674/">Swift算法实现之归并排序</a></li><li class="post-list-item"><a class="post-list-link" href="/article/672/">Swift算法实现之快速排序</a></li><li class="post-list-item"><a class="post-list-link" href="/article/669/">Swift算法实现之翻转二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/article/661/">Swift算法实现之二叉树</a></li><li class="post-list-item"><a class="post-list-link" href="/article/658/">Swift算法实现之栈和队列</a></li><li class="post-list-item"><a class="post-list-link" href="/article/654/">Swift算法实现之查找第K大的元素</a></li><li class="post-list-item"><a class="post-list-link" href="/article/652/">Swift算法实现之数组中出现次数超过一半的数字</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">李峰峰博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>